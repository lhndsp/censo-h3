
WITH
    -- Preencher setores
    setores_polyfill AS (
        SELECT
            jslibs.h3.ST_H3_POLYFILLFROMGEOG(geometria , 9) as geo
        FROM `basedosdados.br_geobr_mapas.setor_censitario_2010`
            WHERE zona = 'URBANO' AND geometria IS NOT NULL
    ),
    -- Malha H3
    h3_hexagons as (
    SELECT
        h3,
        jslibs.h3.ST_H3_BOUNDARY(h3) as h3geo
    FROM setores_polyfill, UNNEST(geo) as h3
    ),
    -- Calculo
    geom_overlap AS(
      SELECT
          h3_hexagons.h3,
          h3_hexagons.h3geo,
          ST_AREA(ST_INTERSECTION(h3geo, setor_geom.geometria)) as intersection_h3,
          ST_AREA(geometria) as setor_area,
idade.v001 AS v001,
idade.v002 AS v002,
idade.v003 AS v003,
idade.v004 AS v004,
idade.v005 AS v005,
idade.v006 AS v006,
idade.v007 AS v007,
idade.v008 AS v008,
idade.v009 AS v009,
idade.v010 AS v010,
idade.v011 AS v011,
idade.v012 AS v012,
idade.v013 AS v013,
idade.v014 AS v014,
idade.v015 AS v015,
idade.v016 AS v016,
idade.v017 AS v017,
idade.v018 AS v018,
idade.v019 AS v019,
idade.v020 AS v020,
idade.v021 AS v021,
idade.v022 AS v022,
idade.v023 AS v023,
idade.v024 AS v024,
idade.v025 AS v025,
idade.v026 AS v026,
idade.v027 AS v027,
idade.v028 AS v028,
idade.v029 AS v029,
idade.v030 AS v030,
idade.v031 AS v031,
idade.v032 AS v032,
idade.v033 AS v033,
idade.v034 AS v034,
idade.v035 AS v035,
idade.v036 AS v036,
idade.v037 AS v037,
idade.v038 AS v038,
idade.v039 AS v039,
idade.v040 AS v040,
idade.v041 AS v041,
idade.v042 AS v042,
idade.v043 AS v043,
idade.v044 AS v044,
idade.v045 AS v045,
idade.v046 AS v046,
idade.v047 AS v047,
idade.v048 AS v048,
idade.v049 AS v049,
idade.v050 AS v050,
idade.v051 AS v051,
idade.v052 AS v052,
idade.v053 AS v053,
idade.v054 AS v054,
idade.v055 AS v055,
idade.v056 AS v056,
idade.v057 AS v057,
idade.v058 AS v058,
idade.v059 AS v059,
idade.v060 AS v060,
idade.v061 AS v061,
idade.v062 AS v062,
idade.v063 AS v063,
idade.v064 AS v064,
idade.v065 AS v065,
idade.v066 AS v066,
idade.v067 AS v067,
idade.v068 AS v068,
idade.v069 AS v069,
idade.v070 AS v070,
idade.v071 AS v071,
idade.v072 AS v072,
idade.v073 AS v073,
idade.v074 AS v074,
idade.v075 AS v075,
idade.v076 AS v076,
idade.v077 AS v077,
idade.v078 AS v078,
idade.v079 AS v079,
idade.v080 AS v080,
idade.v081 AS v081,
idade.v082 AS v082,
idade.v083 AS v083,
idade.v084 AS v084,
idade.v085 AS v085,
idade.v086 AS v086,
idade.v087 AS v087,
idade.v088 AS v088,
idade.v089 AS v089,
idade.v090 AS v090,
idade.v091 AS v091,
idade.v092 AS v092,
idade.v093 AS v093,
idade.v094 AS v094,
idade.v095 AS v095,
idade.v096 AS v096,
idade.v097 AS v097,
idade.v098 AS v098,
idade.v099 AS v099,
idade.v100 AS v100,
idade.v101 AS v101,
idade.v102 AS v102,
idade.v103 AS v103,
idade.v104 AS v104,
idade.v105 AS v105,
idade.v106 AS v106,
idade.v107 AS v107,
idade.v108 AS v108,
idade.v109 AS v109,
idade.v110 AS v110,
idade.v111 AS v111,
idade.v112 AS v112,
idade.v113 AS v113,
idade.v114 AS v114,
idade.v115 AS v115,
idade.v116 AS v116,
idade.v117 AS v117,
idade.v118 AS v118,
idade.v119 AS v119,
idade.v120 AS v120,
idade.v121 AS v121,
idade.v122 AS v122,
idade.v123 AS v123,
idade.v124 AS v124,
idade.v125 AS v125,
idade.v126 AS v126,
idade.v127 AS v127,
idade.v128 AS v128,
idade.v129 AS v129,
idade.v130 AS v130,
idade.v131 AS v131,
idade.v132 AS v132,
idade.v133 AS v133,
idade.v134 AS v134

FROM h3_hexagons
JOIN `basedosdados.br_geobr_mapas.setor_censitario_2010` setor_geom
    ON ST_INTERSECTS(h3_hexagons.h3geo, setor_geom.geometria)
JOIN `basedosdados.br_ibge_censo_demografico.setor_censitario_idade_total_2010` idade USING(id_setor_censitario))
SELECT
    h3,
    ANY_VALUE(h3geo) as geometry,
    ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v001)) as v001,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v002)) as v002,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v003)) as v003,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v004)) as v004,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v005)) as v005,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v006)) as v006,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v007)) as v007,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v008)) as v008,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v009)) as v009,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v010)) as v010,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v011)) as v011,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v012)) as v012,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v013)) as v013,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v014)) as v014,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v015)) as v015,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v016)) as v016,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v017)) as v017,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v018)) as v018,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v019)) as v019,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v020)) as v020,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v021)) as v021,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v022)) as v022,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v023)) as v023,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v024)) as v024,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v025)) as v025,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v026)) as v026,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v027)) as v027,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v028)) as v028,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v029)) as v029,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v030)) as v030,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v031)) as v031,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v032)) as v032,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v033)) as v033,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v034)) as v034,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v035)) as v035,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v036)) as v036,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v037)) as v037,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v038)) as v038,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v039)) as v039,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v040)) as v040,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v041)) as v041,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v042)) as v042,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v043)) as v043,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v044)) as v044,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v045)) as v045,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v046)) as v046,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v047)) as v047,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v048)) as v048,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v049)) as v049,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v050)) as v050,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v051)) as v051,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v052)) as v052,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v053)) as v053,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v054)) as v054,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v055)) as v055,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v056)) as v056,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v057)) as v057,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v058)) as v058,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v059)) as v059,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v060)) as v060,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v061)) as v061,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v062)) as v062,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v063)) as v063,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v064)) as v064,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v065)) as v065,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v066)) as v066,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v067)) as v067,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v068)) as v068,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v069)) as v069,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v070)) as v070,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v071)) as v071,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v072)) as v072,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v073)) as v073,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v074)) as v074,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v075)) as v075,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v076)) as v076,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v077)) as v077,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v078)) as v078,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v079)) as v079,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v080)) as v080,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v081)) as v081,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v082)) as v082,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v083)) as v083,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v084)) as v084,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v085)) as v085,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v086)) as v086,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v087)) as v087,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v088)) as v088,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v089)) as v089,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v090)) as v090,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v091)) as v091,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v092)) as v092,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v093)) as v093,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v094)) as v094,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v095)) as v095,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v096)) as v096,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v097)) as v097,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v098)) as v098,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v099)) as v099,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v100)) as v100,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v101)) as v101,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v102)) as v102,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v103)) as v103,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v104)) as v104,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v105)) as v105,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v106)) as v106,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v107)) as v107,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v108)) as v108,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v109)) as v109,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v110)) as v110,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v111)) as v111,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v112)) as v112,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v113)) as v113,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v114)) as v114,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v115)) as v115,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v116)) as v116,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v117)) as v117,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v118)) as v118,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v119)) as v119,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v120)) as v120,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v121)) as v121,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v122)) as v122,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v123)) as v123,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v124)) as v124,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v125)) as v125,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v126)) as v126,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v127)) as v127,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v128)) as v128,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v129)) as v129,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v130)) as v130,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v131)) as v131,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v132)) as v132,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v133)) as v133,
ROUND(SUM(SAFE_DIVIDE(intersection_h3, setor_area) * v134)) as v134
FROM geom_overlap
  GROUP BY h3
